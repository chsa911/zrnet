<!DOCTYPE html>
<html xmlns:https="http://www.w3.org/1999/xhtml" xmlns:border-radius="http://www.w3.org/1999/xhtml"
      xmlns:float="http://www.w3.org/1999/xhtml">

<head>
    <style>
        html * {
          font-size: 16px;
          line-height: 1.625;
          color: #101013;
          font-family: Arial, sans-serif;
        }
    </style>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Public Books</title>

    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">

    <!-- same as your site/index.html -->
    <link rel="stylesheet" href="/assets/css/styles.min.css">
</head>

<body style=" background-color: #95d4cf">

<!--toparea-->
<header class="zr-topbar">
    <a class="zr-logo" href="/index.html">
        <img src="/assets/images/allgemein/logo.jpeg" alt="Zenreader logo">
    </a>

    <!-- Search submits to THIS public page -->
    <form class="zr-search" action="/public/books/" method="get">
        <input id="qTop" type="text" name="q" placeholder="B√ºcher oder Autoren suchen‚Ä¶">
        <button type="submit" aria-label="Search">üîé</button>
    </form>

    <!-- complete routing options on top (NO "B√ºchertagebuch" link) -->
    <nav class="zr-nav">
        <a class="zr-btn" href="/ueber_mich.html">About me</a>
        <a class="zr-btn" href="/index.html">HOME</a>
        <a class="zr-btn" href="/public/books/">Readingdiary</a>
        <a class="zr-btn" href="/kontaktformular.html">Contact</a>
        <a class="zr-btn" href="/newsletter.html">Newsletter</a>
        <a class="zr-btn" href="/merchandise.html">Shop</a>
        <a class="zr-btn" href="/faq.html">FAQ</a>

        <!-- this public page -->
        <a class="zr-btn" href="/public/books/">Public Books</a>

        <!-- auth/admin (can be secured later) -->
        <a class="zr-btn" href="https://admin.zenreader.net/">Login</a>

        <a class="zr-btn zr-youtube" href="https://www.youtube.com/@zenreader2026">Youtube</a>
        <a class="zr-btn zr-tiktok" href="https://www.tiktok.com/@zenreader26">Tiktok</a>
        <a class="zr-btn zr-instagram" href="https://www.instagram.com/zenreader26/">Instagram</a>
    </nav>
</header>

<!-- same header styling as your site/index.html -->
<style>
    .zr-topbar{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px 16px;
      flex-wrap:wrap;
    }
    .zr-logo img{ height:72px; width:auto; display:block; }
    .zr-search{ display:flex; gap:8px; align-items:center; flex:1 1 260px; }
    .zr-search input{
      width:100%;
      max-width:520px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #cfcfcf;
    }
    .zr-search button{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #cfcfcf;
      background:#fff;
    }
    .zr-nav{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:flex-end;
      margin-left:auto;
    }
    .zr-btn{
      background:#d300bd;
      color:#fff;
      padding:6px 10px;
      border:2px solid #fff;
      border-radius:8px;
      text-decoration:none;
      font-size:14px;
      line-height:1.2;
      display:inline-block;
      white-space:nowrap;
    }
    .zr-youtube{ background:#e60000; }
    .zr-tiktok{ background:#111; }
    .zr-instagram{ background:#d300bd; }
</style>

<!-- content area -->
<div style="background-color: mintcream">
  <main role="main" style="max-width:1100px;margin:0 auto;padding:14px 16px;">
    <h1 style="text-align:center;background-color:rgb(0,255,191);margin:0;padding:6px 0;border-radius:10px;">.</h1>

    <section style="margin-top:14px;border:2px solid white;border-radius:14px;padding:14px;background:rgba(255,255,255,0.65);">
      <h2 style="margin:0 0 6px;">Public Books</h2>
    
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;">
        <div style="flex:1;min-width:240px;">
          <div style="font-size:12px;color:#333;margin-bottom:6px;">Search</div>
          <input id="q" type="text" placeholder="Titel, Autor‚Ä¶" style="width:100%;padding:10px 12px;border-radius:10px;border:1px solid #cfcfcf;">
        </div>

        <div style="min-width:220px;">
          <div style="font-size:12px;color:#333;margin-bottom:6px;">Status</div>
          <select id="reading_status" style="width:100%;padding:10px 12px;border-radius:10px;border:1px solid #cfcfcf;">
            <option value="">All</option>
          </select>
        </div>

        <div style="min-width:200px;">
          <div style="font-size:12px;color:#333;margin-bottom:6px;">Sort</div>
          <select id="sort" style="width:100%;padding:10px 12px;border-radius:10px;border:1px solid #cfcfcf;">
            <option value="newest">Newest added</option>
            <option value="title_asc">Title A‚ÄìZ</option>
          </select>
        </div>

        <button id="btn" style="padding:10px 12px;border-radius:10px;border:1px solid #cfcfcf;background:#fff;cursor:pointer;">
          Search
        </button>
      </div>

      <div id="status" style="margin-top:10px;font-size:12px;color:#333;">Ready.</div>
      <div id="error" style="display:none;margin-top:8px;color:#b00020;font-size:12px;"></div>

      <div id="results" style="margin-top:12px;display:grid;gap:10px;"></div>
    </section>

    <h1 style="text-align:center;background-color:rgb(0,255,191);margin:14px 0 0;padding:6px 0;border-radius:10px;">.</h1>
  </main>
</div>

<script>
  (() => {
    const $ = (id) => document.getElementById(id);

    const esc = (s) =>
      String(s ?? "").replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));

    const setStatus = (msg) => { $("status").textContent = msg; };

    const showError = (msg) => {
      const el = $("error");
      el.style.display = "block";
      el.textContent = msg;
    };

    const clearError = () => {
      const el = $("error");
      el.style.display = "none";
      el.textContent = "";
    };

    function debounce(fn, ms) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), ms);
      };
    }

    function getParams() {
      const sp = new URLSearchParams(location.search);
      return {
        q: (sp.get("q") || "").trim(),
        reading_status: (sp.get("reading_status") || "").trim(),
        sort: (sp.get("sort") || "newest").trim(),
      };
    }

    function setParams({ q, reading_status, sort }) {
      const sp = new URLSearchParams();
      if (q) sp.set("q", q);
      if (reading_status) sp.set("reading_status", reading_status);
      if (sort && sort !== "newest") sp.set("sort", sort);
      const qs = sp.toString();
      history.replaceState(null, "", qs ? `?${qs}` : location.pathname);
    }

    function badge(text) {
      return `<span style="display:inline-block;background:#fff;border:1px solid #ddd;border-radius:999px;padding:2px 8px;margin-right:6px;">${esc(text)}</span>`;
    }

    function render(items) {
      const el = $("results");
      if (!items || items.length === 0) {
        el.innerHTML = `
          <div style="border:2px solid white;border-radius:14px;padding:12px;background:rgba(255,255,255,0.65);">
            <div style="font-size:16px;font-weight:700;">No results</div>
            <div style="font-size:13px;color:#333;">Try a different search or filter.</div>
          </div>`;
        return;
      }

      el.innerHTML = items.map(x => {
        const title = esc(x.title || "(no title)");
        const author = x.author ? badge(`Author: ${x.author}`) : "";
        const status = x.reading_status ? badge(`Status: ${x.reading_status}`) : "";
        const barcode = x.barcode ? badge(`Barcode: ${x.barcode}`) : "";
        const top = x.top_book ? badge("‚≠ê Top book") : "";
        const added = x.registered_at ? badge(`Added: ${new Date(x.registered_at).toLocaleDateString()}`) : "";

        return `
          <div style="border:2px solid white;border-radius:14px;padding:12px;background:rgba(255,255,255,0.65);">
            <div style="font-size:16px;font-weight:700;line-height:1.2;">${title}</div>
            <div style="font-size:13px;color:#333;margin-top:6px;">
              ${author}${status}${barcode}${top}${added}
            </div>
          </div>`;
      }).join("");
    }

    function clientFilterSort(items, reading_status, sort) {
      let out = Array.isArray(items) ? [...items] : [];

      if (reading_status) {
        out = out.filter(x => String(x.reading_status || "") === reading_status);
      }

      if (sort === "title_asc") {
        out.sort((a, b) => String(a.title || "").localeCompare(String(b.title || "")));
      } else {
        const getDate = (x) => String(x.registered_at || "");
        out.sort((a, b) => getDate(b).localeCompare(getDate(a)));
      }

      return out;
    }

    async function fetchBooks(q, reading_status, sort) {
      const params = new URLSearchParams();
      if (q) params.set("q", q);
      if (reading_status) params.set("reading_status", reading_status);
      if (sort) params.set("sort", sort);
      params.set("limit", "200");

      const resp = await fetch(`/api/public/books?${params.toString()}`, {
        headers: { Accept: "application/json" }
      });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const data = await resp.json();
      return Array.isArray(data) ? data : (data.items || []);
    }

    function fillStatusesFrom(items) {
      const sel = $("reading_status");
      if (!sel || sel.dataset.filled === "1") return;

      const statuses = Array.from(new Set(items.map(x => x.reading_status).filter(Boolean))).sort();
      statuses.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        sel.appendChild(opt);
      });
      sel.dataset.filled = "1";
    }

    async function load() {
      clearError();

      const q = $("q").value.trim();
      const reading_status = $("reading_status").value;
      const sort = $("sort").value;

      setParams({ q, reading_status, sort });
      setStatus("loading‚Ä¶");

      const items = await fetchBooks(q, reading_status, sort);

      fillStatusesFrom(items);

      const finalItems = clientFilterSort(items, reading_status, sort);
      render(finalItems);
      setStatus(`Found ${finalItems.length} items.`);
    }

    const debouncedLoad = debounce(() => load().catch(e => {
      console.error(e);
      showError(`Could not load books: ${e?.message || String(e)}`);
      setStatus("error");
    }), 250);

    function initFromUrl() {
      const p = getParams();
      $("q").value = p.q;
      $("sort").value = p.sort || "newest";

      const qTop = $("qTop");
      if (qTop) qTop.value = p.q;

      // First load (fills dropdown), then apply status filter if present
      load().then(() => {
        if (p.reading_status) {
          $("reading_status").value = p.reading_status;
          return load();
        }
      }).catch(e => {
        console.error(e);
        showError(`Could not load books: ${e?.message || String(e)}`);
        setStatus("error");
      });
    }

    $("btn").addEventListener("click", (e) => { e.preventDefault(); debouncedLoad(); });
    $("q").addEventListener("input", debouncedLoad);
    $("reading_status").addEventListener("change", debouncedLoad);
    $("sort").addEventListener("change", debouncedLoad);

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initFromUrl);
    } else {
      initFromUrl();
    }
  })();
</script>

</body>
</html>