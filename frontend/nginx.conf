server {
  listen 80;
  server_name _;

  root /usr/share/nginx/html;
  index index.html;

  client_max_body_size 50m;

  # 1) If someone directly opens /assets/foo.html in the browser,
  # redirect to /foo.html (handled by React router),
  # BUT allow React to fetch the raw file via ?raw=1
  location ~ ^/assets/(?<page>[^/]+\.html)$ {
    if ($arg_raw != "1") { return 302 /$page; }
    try_files $uri =404;
  }

  # 2) Serve legacy static assets (css/images/js/partials)
  location /assets/ {
    try_files $uri =404;
    access_log off;
    expires 7d;
  }

  # 3) Serve Vite bundle files from /spa (immutable caching)
  location /spa/ {
    try_files $uri =404;
    access_log off;
    expires 1y;
    add_header Cache-Control "public, max-age=31536000, immutable";
  }

  # 4) SPA fallback for everything else (React Router)
  location / {
    try_files $uri $uri/ /index.html;
  }
}